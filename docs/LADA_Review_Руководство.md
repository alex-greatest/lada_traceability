# LADA Review — Руководство пользователя

## Содержание

1. [Общее описание системы](#1-общее-описание-системы)
2. [Настройка системы](#2-настройка-системы)
3. [Запуск производства](#3-запуск-производства)
4. [Производственный процесс — полный флоу](#4-производственный-процесс--полный-флоу)
5. [RFID — привязка и отвязка](#5-rfid--привязка-и-отвязка)
6. [Развилки (OP20, OP30)](#6-развилки-op20-op30)
7. [Печать этикеток](#7-печать-этикеток)
8. [Возврат на доработку (рework)](#8-возврат-на-доработку-рework)
9. [Обход маршрута](#9-обход-маршрута)
10. [Просмотр данных и экспорт](#10-просмотр-данных-и-экспорт)
11. [Протокол обмена с ПЛК](#11-протокол-обмена-с-плк)
12. [Справочник кодов ПЛК](#12-справочник-кодов-плк)
13. [Структура базы данных](#13-структура-базы-данных)
14. [Ограничения системы](#14-ограничения-системы)

---

## 1. Общее описание системы

LADA Review — Windows-приложение для контроля качества и прослеживаемости на производственной линии автомобилей LADA.

### Что делает программа:
- Обменивается данными со станциями (ПЛК) по TCP
- Контролирует порядок прохождения деталей по маршруту
- Сохраняет результаты измерений в базу данных
- Печатает этикетки на принтере Zebra
- Позволяет просматривать и экспортировать данные

### Архитектура:

```
  ┌────────────────┐         ┌──────────────────┐        ┌─────────────┐
  │ ПЛК станций    │◄──TCP──►│   Review.exe     │◄──────►│ MySQL       │
  │ (TCP-клиенты)  │         │   (TCP-сервер)   │        │ (lada_db)   │
  └────────────────┘         └──────┬───────────┘        └─────────────┘
                                    │
                                    ▼
                             ┌──────────────┐
                             │ Принтер Zebra│
                             │ (TCP:9100)   │
                             └──────────────┘
```

- **Review.exe** — TCP-сервер. Каждая станция (ПЛК) подключается как клиент.
- **Основной цикл** — 200 мс (обработка данных от всех станций).
- **Сердцебиение** — 1000 мс (переключение сигнала heart).
- **Таймаут связи** — 5 секунд (если станция не отвечает).

### Два типа станций:

| Тип | Описание | Проверка маршрута |
|-----|----------|-------------------|
| **Маршрутные (Used)** | Входят в маршрут продукта. Деталь обязана пройти их по порядку | Строгая: проверяется предыдущая станция |
| **Внемаршрутные (NUsed)** | Не входят в маршрут. Можно использовать в любой момент | Только проверка на повтор |

---

## 2. Настройка системы

Настройка производится **до запуска** линии администратором.

### 2.1 Управление станциями (окно «Станции»)

#### Добавление станции
1. Открыть окно «Станции»
2. Ввести: **Имя** (например OP50), **IP-адрес**, **Порт**
3. Нажать **«Добавить»**

Программа:
- Проверит, что станция с таким именем не существует
- Проверит, что таблица данных не существует
- Добавит запись в таблицу `station`
- **Автоматически создаст таблицу `opOP50`** для хранения измерений

#### Редактирование станции
1. Кликнуть на строку станции в таблице
2. Изменить нужные поля (IP, порт, имя)
3. Нажать **«Изменить»**

> **Внимание:** станцию «Server» изменять и удалять нельзя.

#### Удаление станции
1. Кликнуть на строку станции
2. Нажать **«Удалить»**
3. Подтвердить действие

Программа:
- Удалит запись из таблицы `station`
- **Удалит таблицу `opXX`** со всеми измерениями — данные потеряются навсегда!

### 2.2 Управление продуктами и маршрутами (окно «Продукты»)

#### Создание нового продукта
1. Открыть окно «Продукты»
2. Ввести **название** и **код** продукта
3. Выбрать **первую станцию** маршрута
4. Нажать **«Добавить»**

#### Добавление станции в маршрут
1. Кликнуть на нужную **ячейку** в строке продукта (столбец station1-14)
2. Выбрать станцию из выпадающего списка
3. Установить порядковый номер
4. Нажать **«Изменить»**

Порядок маршрута определяется **столбцами** таблицы:
- `station1` — первая станция маршрута
- `station2` — вторая
- ... до `station14`

Пример маршрута:
| productName | productID | station1 | station2 | station3 | station4 |
|------------|-----------|----------|----------|----------|----------|
| Двигатель_K4M | 205 | OP10 | OP20 | OP40 | |

> **Важно:** маршрут не должен содержать пропусков и дублей — программа это проверяет.

#### Удаление станции из маршрута
- Удалять можно только **последнюю** станцию в маршруте (чтобы не было пропусков)
- Кликнуть на ячейку последней станции → «Удалить»

#### Удаление продукта целиком
1. Установить галочку **«Удалить продукт»**
2. Нажать **«Удалить»**
3. Подтвердить действие

Программа удалит:
- Строку из таблицы `product`
- **Все данные** по этому продукту из таблиц `opXX` всех станций маршрута

### 2.3 Управление пользователями (окно «Пользователи»)

Уровни доступа:
- **Оператор (0)** — только запуск/остановка и просмотр
- **Администратор (1+)** — полный доступ ко всем настройкам

### 2.4 Важное правило: перезапуск

Если линия уже запущена (нажат «Старт»), изменения в станциях и маршрутах **не подхватываются автоматически**.

Порядок действий:
1. Нажать **«Стоп»**
2. Внести изменения
3. Нажать **«Старт»** снова

---

## 3. Запуск производства

### Порядок запуска:
1. Войти в систему (логин + пароль)
2. В главном окне выбрать **продукт** из списка
3. Нажать **«Старт»**

### Что происходит при запуске:
1. Загружаются все станции из базы данных
2. Станции фильтруются под выбранный продукт:
   - Станции из маршрута → **маршрутные (Used)**
   - Остальные → **внемаршрутные (NUsed)**
3. Создаётся TCP-сервер — начинает слушать подключения
4. Запускается основной цикл обработки (каждые 200 мс)

### Подключение станций:
- Каждая станция (ПЛК) подключается к серверу
- Сервер проверяет IP-адрес по белому списку
- Для маршрутных станций строится цепочка (кто за кем):

```
OP10 → OP20 → OP40
(первая)       (последняя)
```

Каждая станция знает имя предыдущей — это нужно для проверки маршрута.

---

## 4. Производственный процесс — полный флоу

### Пример: деталь «ABC-001» проходит маршрут OP10 → OP20 → OP40

### Шаг 1: Деталь на OP10 (первая станция)

Рабочий сканирует штрих-код «ABC-001», ставит деталь.

1. **ПЛК отправляет status=1** — «Можно работать?»
2. Программа проверяет: OP10 — первая станция → **всегда разрешено**
3. Программа создаёт запись в таблице прослеживаемости (`stationprocode`)
4. **Программа отвечает feedBack=1** — «Работай»
5. ПЛК выполняет операцию, получает измерения
6. **ПЛК отправляет status=2** — «Сохрани результаты», quality=1 (ОК)
7. Программа сохраняет измерения в `opOP10`, обновляет `stationprocode`
8. **Программа отвечает feedBack=2** — «Сохранено»
9. ПЛК сбрасывает в **status=0** — цикл завершён

### Шаг 2: Деталь на OP20 (вторая станция, развилка)

1. **ПЛК отправляет status=21** — «Проверка для развилки»
2. Программа проверяет: предыдущая станция (OP10) пройдена? → Да ✓
3. **Программа отвечает feedBack=1, leftOrRight=1** — «Работай на ST1»
4. ST1 выполняет работу
5. **ПЛК отправляет status=22** — «Сохрани данные ST1»
6. Программа сохраняет (INSERT в `opOP20`)
7. Деталь переходит на ST2
8. **ПЛК отправляет status=24** — «Сохрани данные ST2»
9. Программа дополняет (UPDATE той же строки в `opOP20`, другие столбцы)

### Шаг 3: Деталь на OP40 (последняя станция)

1. **ПЛК отправляет status=1** — «Можно работать?»
2. Программа проверяет: OP20 пройдена? → Да ✓
3. **feedBack=1**
4. ПЛК выполняет операцию
5. **ПЛК отправляет status=2** — результаты
6. Программа сохраняет в `opOP40`
7. **OP40 — последняя станция**, поэтому:
   - Печатается этикетка на принтере Zebra
   - Создаётся запись в `finalprintcode`
8. Деталь готова!

---

## 5. RFID — привязка и отвязка

RFID используется для отслеживания деталей на станциях **без сканера штрих-кодов**.

### Привязка (status=3)

Когда деталь впервые сканируется на станции с RFID-считывателем:

1. ПЛК отправляет: `status=3`, штрих-код + RFID-метка
2. Программа записывает в таблицу `rfidbind`: RFID ↔ штрих-код
3. Отвечает: `feedBack=2` (успешно)

**Ошибки привязки:**
- `feedBack=71` — штрих-код пустой
- `feedBack=72` — RFID пустой
- `feedBack=77` — обновлено больше одной записи (только для NUsed)

### Использование

На следующих станциях:
- ПЛК считывает RFID-метку
- Программа находит привязанный штрих-код
- Работает так, как будто сканировали штрих-код

### Отвязка (status=4)

На последней станции маршрута:

1. ПЛК отправляет: `status=4`, RFID-метка
2. Программа находит привязанный штрих-код
3. Передаёт штрих-код обратно на ПЛК (в `productCode`)
4. Очищает привязку в `rfidbind`, сохраняет предыдущий код в столбец `last`
5. Отвечает: `feedBack=2`

**Ошибки отвязки:**
- `feedBack=73` — на RFID нет привязанного штрих-кода
- `feedBack=74` — RFID пустой

После отвязки метка свободна для следующей детали.

---

## 6. Развилки (OP20, OP30)

Станции OP20 и OP30 имеют **два рабочих места** (ST1 и ST2).

### Логика маршрута

**OP20:**
- Предыдущая станция OP10 → направляем на **ST1** (`leftOrRight=1`)
- Предыдущая OP20_ST1 → направляем на **ST2** (`leftOrRight=2`)

**OP30:**
- Предыдущая OP20_ST2 → направляем на **ST1** (`leftOrRight=1`)
- Предыдущая OP30_ST1 → направляем на **ST2** (`leftOrRight=2`)

### Как сохраняются данные

| Действие | Код status | Что происходит в БД |
|----------|-----------|---------------------|
| OP20 ST1 сохранение | **22** | INSERT новой строки в `opOP20` |
| OP20 ST2 сохранение | **24** | UPDATE той же строки (другие столбцы) |
| OP30 ST1 сохранение | **32** | INSERT новой строки в `opOP30` |
| OP30 ST2 сохранение | **34** | UPDATE той же строки (другие столбцы) |

> **Важно:** ST1 и ST2 — **не взаимозаменяемые**. ST1 делает INSERT, ST2 делает UPDATE. Они пишут разные поля в одну строку таблицы.

---

## 7. Печать этикеток

Печать происходит автоматически на **последней станции маршрута** (OP40) при status=2, если деталь прошла успешно (quality ≠ 2).

### Процесс:
1. Программа читает шаблон этикетки из файла `.prn` (ZPL-код)
2. Подставляет данные: штрих-код, название, дату
3. Сохраняет модифицированный файл
4. Отправляет по TCP на принтер Zebra (IP: 192.168.1.45, порт 9100)
5. Записывает код печати в таблицу `finalprintcode`

### Принудительная печать (by2=42)

ПЛК может запросить печать вне основного процесса, отправив `by2=42`:
- Программа печатает этикетку
- Генерирует следующий код печати
- Отвечает: `byI2=42`

---

## 8. Возврат на доработку (rework)

Если на какой-то станции обнаружен **брак** (quality=2):

1. Деталь возвращается на **первую станцию** маршрута
2. Первая станция **всегда пускает** (`feedBack=1`)
3. Деталь проходит **весь маршрут заново** с первой станции по порядку
4. Перепрыгнуть сразу на нужную станцию **нельзя** — строгий последовательный порядок

---

## 9. Обход маршрута

### Способ 1: by2 = 88 (принудительное сохранение)

ПЛК отправляет специальный код `by2=88`:
- Данные сохраняются **без проверки маршрута**
- Пауза 3 секунды после сохранения
- Работает как на маршрутных, так и на внемаршрутных станциях

### Способ 2: by2 = 89 (альтернативное сохранение)

Аналогично by2=88:
- На маршрутных станциях: обычное сохранение без проверки
- На внемаршрутных: сохранение в таблицу `OP80_2`
- Пауза 3 секунды

### Способ 3: Первая станция маршрута

Первая станция маршрута **всегда** разрешает работу (`feedBack=1`), независимо от состояния детали.

### Способ 4: OP50

Станция OP50 имеет специальный статус — пропускает стандартные проверки маршрута, аналогично первой станции.

---

## 10. Просмотр данных и экспорт

### Окно «Просмотр данных» (FrmReview)

#### Режим 1: По станции

Запрашивает данные из таблицы `opXX` конкретной станции.

**Фильтры:**
- Продукт
- Станция
- Диапазон дат (с... по...)
- Штрих-код (конкретная деталь)
- Результат: Все / ОК / Брак

**Пример использования:**
1. Выбрать станцию: OP20
2. Указать период: с 01.08.2025 по 31.08.2025
3. Результат: Брак
4. Нажать «Запрос»
→ Покажет все бракованные детали на OP20 за август

#### Режим 2: Полная прослеживаемость

Показывает **весь путь** детали по всем станциям маршрута.

**Пример:**
1. Ввести штрих-код: ABC-001
2. Нажать «Запрос»
→ Покажет: OP10 ✓ → OP20 ✓ → OP40 ✓, с результатами и кодом печати

Данные берутся из таблицы `stationprocode` + `finalprintcode`.

#### Экспорт в Excel

На любом этапе после запроса:
1. Нажать **«Экспорт»**
2. Выбрать путь сохранения
3. Данные сохраняются в `.xls` файл

---

## 11. Протокол обмена с ПЛК

### Общие характеристики

| Параметр | Значение |
|----------|----------|
| Транспорт | TCP |
| Review.exe | TCP-сервер |
| ПЛК | TCP-клиент |
| Порядок байтов | Big-endian (старший байт первый) |
| Кодировка строк | ASCII (заполнение пробелами 0x20) |
| Цикл обмена | 200 мс |
| Таймаут | 5 секунд |

---

### 11.1 Пакет от ПЛК → Программе (450 байт)

| Смещение | Размер | Тип | Поле | Описание |
|----------|--------|-----|------|----------|
| **Байт 0 (биты)** | | | | **Битовые флаги — байт 0** |
| 0, бит 0 | 1 бит | bool | Estop | Аварийная остановка |
| 0, бит 1 | 1 бит | bool | heart | Сердцебиение станции |
| 0, бит 2 | 1 бит | bool | alarmMaterial | Тревога: материалы |
| 0, бит 3 | 1 бит | bool | alarmQuality | Тревога: качество |
| 0, бит 4 | 1 бит | bool | alarmEquipment | Тревога: оборудование |
| 0, бит 5 | 1 бит | bool | alarmHelp | Тревога: вызов помощи |
| 0, бит 6 | 1 бит | bool | by06 | Резерв |
| 0, бит 7 | 1 бит | bool | by07 | Резерв |
| **Байт 1 (биты)** | | | | **Битовые флаги — байт 1** |
| 1, бит 0-7 | 8 бит | bool | by10..by17 | Резерв |
| **Целочисленные поля** | | | | |
| 2-3 | 2 байта | Int16 BE | **status** | **Код состояния станции (главное поле)** |
| 4-5 | 2 байта | Int16 BE | **quality** | **Результат проверки** (1=ОК, 2=Брак) |
| 6-7 | 2 байта | Int16 BE | by1 | Флаг дополнительной станции |
| 8-9 | 2 байта | Int16 BE | **by2** | **Спец. команды** (88, 89, 42) |
| **Строки** | | | | |
| 10-29 | 20 байт | ASCII | **RFID** | Код RFID-метки |
| **Массив измерений** | | | | |
| 50-129 | 80 байт | float BE ×20 | **result[0..19]** | 20 результатов измерений (4 байта каждый) |
| **Штрих-коды** | | | | |
| 130-169 | 40 байт | ASCII | **productCode** | Основной штрих-код продукта |
| 170-209 | 40 байт | ASCII | barcode2 | Доп. штрих-код 2 |
| 210-249 | 40 байт | ASCII | barcode3 | Доп. штрих-код 3 |
| 250-289 | 40 байт | ASCII | barcode4 | Доп. штрих-код 4 |
| 290-329 | 40 байт | ASCII | barcode5 | Доп. штрих-код 5 |
| 330-369 | 40 байт | ASCII | barcode6 | Доп. штрих-код 6 |
| 370-409 | 40 байт | ASCII | barcode7 | Доп. штрих-код 7 |
| 410-449 | 40 байт | ASCII | barcode8 | Доп. штрих-код 8 / RFID для 2-й станции |

**Примечания:**
- Все Int16 — Big-endian (старший байт первый)
- Все float — Big-endian (4 байта, IEEE 754, реверс порядка)
- Строки — ASCII, заполнены пробелами (0x20) до полной длины

---

### 11.2 Пакет от Программы → ПЛК (330 байт)

| Смещение | Размер | Тип | Поле | Описание |
|----------|--------|-----|------|----------|
| **Байт 0 (биты)** | | | | **Управляющие флаги** |
| 0, бит 7 | 1 бит | bool | **heart** | Сердцебиение сервера (переключается каждую секунду) |
| 0, бит 6 | 1 бит | bool | **run** | Линия запущена |
| 0, бит 5 | 1 бит | bool | **enable** | Станция активирована |
| 0, бит 4 | 1 бит | bool | model | Режим: false=производство, true=ремонт |
| 0, бит 3 | 1 бит | bool | by04 | Резерв |
| 0, бит 2 | 1 бит | bool | by05 | Резерв |
| 0, бит 1 | 1 бит | bool | by06 | Резерв |
| 0, бит 0 | 1 бит | bool | by07 | Резерв |
| **Байт 1 (биты)** | | | | **Источники штрих-кодов** |
| 1, бит 7 | 1 бит | bool | codeSource1 | Источник данных штрих-код 1 |
| 1, бит 6 | 1 бит | bool | codeSource2 | Источник данных штрих-код 2 |
| 1, бит 5 | 1 бит | bool | codeSource3 | Источник данных штрих-код 3 |
| 1, бит 4 | 1 бит | bool | codeSource4 | Источник данных штрих-код 4 |
| 1, бит 3 | 1 бит | bool | codeSource5 | Источник данных штрих-код 5 |
| 1, бит 2 | 1 бит | bool | codeSource6 | Источник данных штрих-код 6 |
| 1, бит 1 | 1 бит | bool | codeSource7 | Источник данных штрих-код 7 |
| 1, бит 0 | 1 бит | bool | codeSource8 | Источник данных штрих-код 8 |
| **Целочисленные поля** | | | | |
| 2-3 | 2 байта | Int16 BE | **feedBack** | **Ответ программы (главное поле)** |
| 4-5 | 2 байта | Int16 BE | **type** | Код типа продукта |
| 6-7 | 2 байта | Int16 BE | **leftOrRight** | Направление на развилке (1=ST1, 2=ST2) |
| 8-9 | 2 байта | Int16 BE | **byI2** | Ответ для 2-й станции / спец. команды |
| **Штрих-коды** | | | | |
| 10-49 | 40 байт | ASCII | **productCode** | Штрих-код продукта (передаётся на ПЛК) |
| 50-89 | 40 байт | ASCII | barcode2 | Доп. штрих-код 2 |
| 90-129 | 40 байт | ASCII | barcode3 | Доп. штрих-код 3 |
| 130-169 | 40 байт | ASCII | barcode4 | Доп. штрих-код 4 |
| 170-209 | 40 байт | ASCII | barcode5 | Доп. штрих-код 5 |
| 210-249 | 40 байт | ASCII | barcode6 | Доп. штрих-код 6 |
| 250-289 | 40 байт | ASCII | barcode7 | Доп. штрих-код 7 |
| 290-329 | 40 байт | ASCII | barcode8 | Доп. штрих-код 8 |

**Примечания:**
- Строки заполняются пробелами (0x20) до 40 байт
- Если строка короче 40 символов — остаток заполнен пробелами
- Биты в байте 0 упакованы: бит 7 — старший (heart), бит 0 — младший (by07)

---

## 12. Справочник кодов ПЛК

### 12.1 Коды status (от ПЛК → Программе)

Главное поле, определяющее что хочет ПЛК.

#### Базовые коды (все станции)

| status | Назначение | Что делает программа | Ожидаемый ответ |
|--------|-----------|---------------------|-----------------|
| **0** | Ожидание (нет запроса) | Сброс всех флагов. Обнуляет feedBack, сбрасывает haveSave и Execution | feedBack = 0 |
| **1** | Запрос на проверку маршрута | Проверяет, может ли деталь работать на этой станции (см. логику ниже) | feedBack = 1 / -1 / 91-94 |
| **2** | Сохранение результатов | Сохраняет измерения в `opXX`, обновляет `stationprocode`. На OP40 дополнительно печатает этикетку | feedBack = 2 |
| **3** | Привязка RFID | Записывает связку RFID ↔ штрих-код в `rfidbind` | feedBack = 2 / 71 / 72 / 77 |
| **4** | Отвязка RFID | Находит привязанный код, передаёт на ПЛК, очищает привязку | feedBack = 2 / 73 / 74 |

#### Коды развилки OP20 (станции с двумя рабочими местами)

| status | Назначение | Что делает программа |
|--------|-----------|---------------------|
| **21** | Проверка маршрута для OP20 | Проверяет предыдущую станцию, определяет направление (ST1 или ST2). Возвращает leftOrRight = 1 или 2 |
| **22** | Сохранение данных OP20 ST1 | INSERT новой строки в `opOP20` |
| **24** | Сохранение данных OP20 ST2 | UPDATE существующей строки в `opOP20` (другие столбцы) |

#### Коды развилки OP30

| status | Назначение | Что делает программа |
|--------|-----------|---------------------|
| **31** | Проверка маршрута для OP30 | Проверяет предыдущую станцию, определяет направление. Возвращает leftOrRight = 1 или 2 |
| **32** | Сохранение данных OP30 ST1 | INSERT новой строки в `opOP30` |
| **34** | Сохранение данных OP30 ST2 | UPDATE существующей строки в `opOP30` (другие столбцы) |

#### Специальные коды

| status | Назначение | Что делает программа |
|--------|-----------|---------------------|
| **41** | Подтверждение сканированного штрих-кода | Сравнивает отсканированный код с `finalprintcode`. Если совпадает → обновляет `scancode`, feedBack=2. Если нет → feedBack=3 |
| **82** | Сохранение данных в OP80_2 | Сохраняет данные в отдельную таблицу `OP80_2` (только для NUsed станций) |

---

### 12.2 Коды by2 (спец. команды от ПЛК)

Работают **параллельно** с основным status, проверяются отдельно.

| by2 | Назначение | Что делает программа |
|-----|-----------|---------------------|
| **0** | Нормальный режим | Сброс флагов setPrint и byI2 |
| **88** | Принудительное сохранение (без проверки маршрута) | Сохраняет данные в `opXX` без проверки маршрута и прослеживаемости. Пауза 3 сек. feedBack=2 |
| **89** | Альтернативное сохранение | На маршрутных: как by2=88. На внемаршрутных: сохранение в `OP80_2`. Пауза 3 сек |
| **42** | Принудительная печать этикетки | Печатает этикетку на Zebra, генерирует новый код, byI2=42. Пауза 3 сек |

---

### 12.3 Коды feedBack (от Программы → ПЛК)

Ответ программы на запрос станции.

#### Основные коды

| feedBack | Значение | Когда возвращается |
|----------|---------|-------------------|
| **0** | Ожидание / нет ответа | При status=0 (сброс) |
| **1** | Разрешено, работай | Маршрут проверен, деталь допущена |
| **2** | Данные сохранены | После успешного сохранения (status=2, 3, 4, 22, 24, 32, 34, 41, 82, by2=88/89) |
| **3** | Код не совпал (при status=41) | Отсканированный код не соответствует ожидаемому в `finalprintcode` |
| **-1** | Запрещено | Деталь не найдена в прослеживаемости (нет записей), нельзя продолжить |
| **-2** | Не найден код оценки (OP90) | В штрих-коде не найдена информация о grade |

#### Коды ошибок маршрута

| feedBack | Значение | Подробности |
|----------|---------|-------------|
| **91** | Деталь уже прошла успешно | Деталь с таким штрих-кодом уже имеет статус ОК на первой станции. Повторный проход запрещён |
| **92** | Предыдущая станция — брак | Деталь прошла предыдущую станцию с результатом «Брак», работа не разрешена |
| **93** | Более поздняя станция уже пройдена | У детали уже есть запись на станции дальше по маршруту — нарушение порядка |
| **94** | Предыдущая станция не пройдена | Деталь не проходила предыдущую станцию маршрута — нельзя пропускать |

#### Коды ошибок RFID

| feedBack | Значение | Когда возвращается |
|----------|---------|-------------------|
| **71** | Штрих-код пустой при привязке RFID | status=3, но productCode пустой |
| **72** | RFID пустой при привязке | status=3, но RFID пустой |
| **73** | Нет привязки при отвязке | status=4, но на этой RFID-метке нет привязанного кода |
| **74** | RFID пустой при отвязке | status=4, но RFID пустой |
| **77** | Ошибка привязки (множественное обновление) | При привязке обновилось больше одной записи (только NUsed) |

#### Специальный код

| feedBack | Значение |
|----------|---------|
| **41** | Деталь ожидает проверки штрих-кода | Возвращается на OP40 когда запись в `finalprintcode` существует, но поле `scancode` пустое — ПЛК должен отсканировать этикетку (status=41) |

---

### 12.4 Коды quality (от ПЛК → Программе)

| quality | Значение |
|---------|---------|
| **1** | ОК (годная деталь) |
| **2** | Брак (негодная деталь) |

---

### 12.5 Коды leftOrRight (от Программы → ПЛК)

Используется только на станциях-развилках (OP20, OP30).

| leftOrRight | Значение |
|------------|---------|
| **1** | Направить на ST1 (первое рабочее место) |
| **2** | Направить на ST2 (второе рабочее место) |

---

### 12.6 Коды byI2 (от Программы → ПЛК)

| byI2 | Значение |
|------|---------|
| **0** | Нормальный режим |
| **42** | Этикетка напечатана (ответ на by2=42) |

---

### 12.7 Диаграмма обмена — типовые сценарии

#### Сценарий 1: Обычная станция (ОК)

```
ПЛК                          Программа
 │                                │
 │  status=1, productCode="ABC"   │
 │ ─────────────────────────────► │  Проверка маршрута...
 │                                │  ОК
 │  feedBack=1                    │
 │ ◄───────────────────────────── │
 │                                │
 │  (ПЛК выполняет операцию)     │
 │                                │
 │  status=2, quality=1,          │
 │  result[]={...}                │
 │ ─────────────────────────────► │  Сохранение в opXX
 │                                │  Обновление stationprocode
 │  feedBack=2                    │
 │ ◄───────────────────────────── │
 │                                │
 │  status=0                      │
 │ ─────────────────────────────► │  Сброс
 │  feedBack=0                    │
 │ ◄───────────────────────────── │
```

#### Сценарий 2: Проверка не пройдена

```
ПЛК                          Программа
 │                                │
 │  status=1, productCode="ABC"   │
 │ ─────────────────────────────► │  Проверка маршрута...
 │                                │  Предыдущая не пройдена!
 │  feedBack=94                   │
 │ ◄───────────────────────────── │
 │                                │
 │  status=0                      │
 │ ─────────────────────────────► │  Сброс
 │  feedBack=0                    │
 │ ◄───────────────────────────── │
```

#### Сценарий 3: RFID привязка + отвязка

```
ПЛК                          Программа
 │                                │
 │  status=3, RFID="TAG-42",     │
 │  productCode="ABC"             │
 │ ─────────────────────────────► │  Запись в rfidbind
 │  feedBack=2                    │
 │ ◄───────────────────────────── │
 │                                │
 │  ... (деталь проходит станции) │
 │                                │
 │  status=4, RFID="TAG-42"      │
 │ ─────────────────────────────► │  Поиск привязки
 │                                │  → productCode = "ABC"
 │  feedBack=2,                   │  Очистка rfidbind
 │  productCode="ABC"             │
 │ ◄───────────────────────────── │
```

#### Сценарий 4: Развилка OP20

```
ПЛК                          Программа
 │                                │
 │  status=21, productCode="ABC"  │
 │ ─────────────────────────────► │  Проверка + определение
 │                                │  направления
 │  feedBack=1, leftOrRight=1     │  (предыдущая=OP10 → ST1)
 │ ◄───────────────────────────── │
 │                                │
 │  (ST1 работает)                │
 │                                │
 │  status=22, quality=1,         │
 │  result[]={...}                │
 │ ─────────────────────────────► │  INSERT в opOP20
 │  feedBack=2                    │
 │ ◄───────────────────────────── │
 │                                │
 │  (ST2 работает)                │
 │                                │
 │  status=24, quality=1,         │
 │  result[]={...}                │
 │ ─────────────────────────────► │  UPDATE той же строки
 │  feedBack=2                    │  в opOP20
 │ ◄───────────────────────────── │
```

#### Сценарий 5: Обход маршрута (by2=88)

```
ПЛК                          Программа
 │                                │
 │  by2=88, данные измерений      │
 │ ─────────────────────────────► │  Сохранение БЕЗ проверки
 │                                │  маршрута
 │  feedBack=2                    │  + пауза 3 сек
 │ ◄───────────────────────────── │
 │                                │
 │  by2=0                         │
 │ ─────────────────────────────► │  Сброс
```

---

## 13. Структура базы данных

### Таблицы и их назначение

| Таблица | Назначение | Кто пишет | Когда |
|---------|-----------|-----------|-------|
| `station` | Список станций (имя, IP, порт) | Администратор через UI | Настройка |
| `product` | Продукты + маршруты (station1-14) | Администратор через UI | Настройка |
| `usertable` | Пользователи и пароли | Администратор через UI | Настройка |
| `stationprocode` | Прогресс детали по маршруту | MyTimer автоматически | status=1 (INSERT), status=2 (UPDATE) |
| `op[XX]` | Измерения на каждой станции | MyTimer автоматически | status=2/22/24/32/34, by2=88/89 |
| `rfidbind` | Привязка RFID ↔ штрих-код | MyTimer автоматически | status=3 (привязка), status=4 (отвязка) |
| `finalprintcode` | Код напечатанной этикетки | MyTimer автоматически | На последней станции (OP40) |
| `printcode` | Шаблон/счётчик кодов для печати | MyTimer автоматически | При печати |
| `scancode` | Результат сканирования этикеток | MyTimer автоматически | status=41 |
| `standardcode` | Эталонные значения | Конфигурация | Настройка |
| `reviewdata` | Данные для просмотра | Программа | При запросах |

### Пример содержимого ключевых таблиц

#### station
| Id | name | ip | port |
|----|------|-----|------|
| 1 | Server | 192.168.1.1 | 5000 |
| 2 | OP10 | 192.168.1.10 | 5001 |
| 3 | OP20 | 192.168.1.20 | 5002 |
| 4 | OP40 | 192.168.1.40 | 5004 |
| 5 | OP90 | 192.168.1.90 | 5009 |

#### product
| productName | productID | station1 | station2 | station3 |
|------------|-----------|----------|----------|----------|
| Двигатель_K4M | 205 | OP10 | OP20 | OP40 |

#### stationprocode (прослеживаемость)
| productcode | productName | station1 | result1 | station2 | result2 | station3 | result3 |
|------------|-------------|----------|---------|----------|---------|----------|---------|
| ABC-001 | Двигатель_K4M | OP10 | 1 | OP20 | 1 | OP40 | 1 |
| ABC-002 | Двигатель_K4M | OP10 | 1 | OP20 | 2 | OP40 | |

#### opOP20 (измерения на станции OP20)
| productcode | productName | result | data1 (ST1) | data2 (ST1) | data5 (ST2) | data6 (ST2) | time |
|------------|-------------|--------|-------------|-------------|-------------|-------------|------|
| ABC-001 | Двигатель_K4M | 1 | 5.1 | 2.3 | 7.8 | 1.1 | 10:20:15 |

#### rfidbind
| rfid | bindcode | bindName | last |
|------|----------|----------|------|
| RFID-TAG-42 | ABC-003 | Двигатель_K4M | ABC-001 |

---

## Итоговая схема системы

```
  ┌─────────────────────────────────────────────────────────────────┐
  │                      НАСТРОЙКА                                   │
  │                                                                  │
  │  FrmStation              FrmProduct             FrmUser          │
  │  ┌──────────┐           ┌──────────────┐       ┌──────────┐    │
  │  │ Станции  │           │ Продукты +   │       │Пользо-   │    │
  │  │ + opXX   │           │ маршруты     │       │ватели    │    │
  │  │ таблица  │           │ station1-14  │       │          │    │
  │  └──────────┘           └──────────────┘       └──────────┘    │
  └──────────────────────────┬──────────────────────────────────────┘
                             │ Стоп → Изменения → Старт
                             ▼
  ┌─────────────────────────────────────────────────────────────────┐
  │                     ПРОИЗВОДСТВО                                 │
  │                                                                  │
  │  ┌───────────────┐                    ┌──────────────────────┐  │
  │  │ ПЛК станций   │ ◄── 330 байт ──── │    Review.exe        │  │
  │  │ (TCP-клиенты) │ ─── 450 байт ───► │    (TCP-сервер)      │  │
  │  │               │                    │                      │  │
  │  │ status →      │   Запрос           │ ← Проверка маршрута  │  │
  │  │ ← feedBack    │   Ответ            │   stationprocode     │  │
  │  │               │                    │                      │  │
  │  │ status=2 →    │   Результаты       │ → Сохранение         │  │
  │  │ ← feedBack=2  │   Сохранены        │   opXX               │  │
  │  │               │                    │                      │  │
  │  │ status=3 →    │   RFID             │ → rfidbind           │  │
  │  │ status=4 →    │   привязка/        │                      │  │
  │  │               │   отвязка          │                      │  │
  │  │ by2=88 →      │   Обход            │ → opXX (без          │  │
  │  │               │   маршрута         │   проверки)          │  │
  │  └───────────────┘                    └───────┬──────────────┘  │
  │                                               │                  │
  │                                               ▼                  │
  │                                       ┌──────────────┐          │
  │                                       │ Принтер Zebra│          │
  │                                       │ IP:9100      │          │
  │                                       │ ZPL этикетки │          │
  │                                       └──────────────┘          │
  └──────────────────────────┬──────────────────────────────────────┘
                             │
                             ▼
  ┌─────────────────────────────────────────────────────────────────┐
  │                     ПРОСМОТР ДАННЫХ                              │
  │                                                                  │
  │  FrmReview                                                       │
  │  ┌───────────────────────────────────────────────────────────┐  │
  │  │                                                           │  │
  │  │  По станции:      SELECT * FROM opXX WHERE фильтры       │  │
  │  │  Прослеживаемость: SELECT * FROM stationprocode           │  │
  │  │                     JOIN finalprintcode                    │  │
  │  │                                                           │  │
  │  │  Фильтры: продукт, станция, дата, штрих-код, результат   │  │
  │  │                                                           │  │
  │  │  → Экспорт в Excel (.xls)                                │  │
  │  │                                                           │  │
  │  └───────────────────────────────────────────────────────────┘  │
  └─────────────────────────────────────────────────────────────────┘
```

---

## 14. Ограничения системы

### 14.1 Развилки (ST1/ST2) нельзя добавить через UI

Станции-развилки (с двумя рабочими местами ST1 и ST2) **жёстко прописаны в коде программы**. В текущей версии поддерживаются только:

- **OP20** (ST1 + ST2) — коды status: 21, 22, 24
- **OP30** (ST1 + ST2) — коды status: 31, 32, 34

#### Что захардкожено:

**1. Коды status привязаны к конкретным станциям:**

| Коды status | Станция | Назначение |
|-------------|---------|-----------|
| 21, 22, 24 | Только OP20 | Проверка, сохранение ST1, сохранение ST2 |
| 31, 32, 34 | Только OP30 | Проверка, сохранение ST1, сохранение ST2 |

Других кодов для развилок в программе нет.

**2. Имена станций прописаны в логике маршрута:**

Для OP20 (status=21):
- Если предыдущая станция = `"OP10"` → направить на ST1 (`leftOrRight=1`)
- Если предыдущая станция = `"OP20_ST1"` → направить на ST2 (`leftOrRight=2`)

Для OP30 (status=31):
- Если предыдущая станция = `"OP20_ST2"` → направить на ST1 (`leftOrRight=1`)
- Если предыдущая станция = `"OP30_ST1"` → направить на ST2 (`leftOrRight=2`)

Все эти имена — строковые константы в коде, не в базе данных.

**3. Методы сохранения — отдельные для каждой развилки:**

| status | Вызываемый метод | Действие |
|--------|-----------------|----------|
| 22 (OP20 ST1) | `SaveStationData()` | INSERT новой строки |
| 24 (OP20 ST2) | `updateStationData_20()` | UPDATE существующей строки |
| 32 (OP30 ST1) | `SaveStationData()` | INSERT новой строки |
| 34 (OP30 ST2) | `updateStationData_30()` | UPDATE существующей строки |

Методы `updateStationData_20()` и `updateStationData_30()` — отдельные функции с SQL-запросами, специфичными для каждой станции.

#### Что нужно для добавления новой развилки

Чтобы добавить, например, OP60 с ST1/ST2, необходимо **изменить исходный код**:

1. Выбрать новые коды status (например 61, 62, 64)
2. Добавить обработку этих кодов в `MyTimer.DealNetUsedData()`
3. Прописать логику маршрута с именами станций (кто предыдущий → куда направить)
4. Написать метод `updateStationData_60()` в `DBHelper` для UPDATE данных ST2
5. Перекомпилировать `Review.exe`
6. Запрограммировать ПЛК на новые коды status

### 14.2 Обычные станции — добавляются свободно

Обычные станции (без ST1/ST2) можно добавлять без изменения кода:

| Действие | Через UI | Нужна перекомпиляция |
|----------|----------|---------------------|
| Добавить обычную станцию | Да (FrmStation) | Нет |
| Добавить станцию в маршрут | Да (FrmProduct) | Нет |
| Добавить развилку (ST1/ST2) | **Нет** | **Да** |
| Изменить порядок маршрута | Да (FrmProduct) | Нет |
| Добавить новый продукт | Да (FrmProduct) | Нет |

### 14.3 Другие ограничения

| Ограничение | Описание |
|-------------|----------|
| Максимум 14 станций в маршруте | Столбцы station1..station14 в таблице `product` |
| Максимум 20 измерений на станцию | Массив `result[0..19]` в пакете от ПЛК |
| Максимум 8 штрих-кодов на станцию | Поля productCode + barcode2..barcode8 |
| Длина штрих-кода — до 40 символов | Размер поля в бинарном пакете (40 байт ASCII) |
| Длина RFID — до 20 символов | Размер поля в бинарном пакете (20 байт ASCII) |
| IP принтера Zebra захардкожен | `192.168.1.45` в коде MyTimer.printCode() |
| Последняя станция печати — OP40 | Логика печати привязана к имени `"OP40"` в коде |
| OP50 — специальная станция | Пропускает проверку маршрута, захардкожено в коде |
| OP90 — станция оценки | Логика проверки grade захардкожена для `"OP90"` |
| Изменения не подхватываются на лету | Нужен перезапуск линии (Стоп → Старт) |
